(function(app,$){var data=[];app.collection={set:function(arr){data=arr;app.$wrap.trigger("addCollection",[data])},toJSON:function(){return data},add:function(todo){data.push(todo);app.$wrap.trigger("addCollection",[data])},remove:function(id){for(var i=0;i<data.length;i++){if(data[i].id===id){console.log("find",i);data.splice(i,1);break}}app.$wrap.trigger("removeCollection",[data])},changed:function(){app.$wrap.trigger("addCollection",[data])}}})(Todo,jQuery);(function(app){app.model={id:"",title:"",isCheck:""}})(Todo);(function($,app){var $listDom=$("#todoList");var todoTemplateHtml=$("#todoTemplate").html();app.view={addTodo:function(event){var $field=$(event.currentTarget);var fieldValue=$field.val();var isValue=$field.checked;if(event.keyCode!==13||fieldValue===""){console.log("event stop");return false}$field.val("");var todo=$.extend({},app.model,{id:app.util.uniqId(),title:fieldValue,isCheck:false});app.collection.add(todo)},render:function(){$listDom.html(tmpl(todoTemplateHtml,{todos:app.collection.toJSON()}))}};app.$wrap.on("addCollection",app.view.render);app.$wrap.on("removeCollection",app.view.render);app.$wrap.on("changedCollection",app.view.render)})(jQuery,Todo);var Todo={$wrap:$(document.body),storageKey:"todos"};(function($,global,app){var $todoStringField=$("#todoString");var $listDom=$("#todoList");$todoStringField.on("keyup",app.view.addTodo);$listDom.on("click",".delete",function(event){var $deleteBtn=$(event.target);var id=$deleteBtn.parent().data("id");app.collection.remove(id)});$listDom.on("click",".toggle_checked",function(event){var $toggleBtn=$(event.target);var checked=$toggleBtn.checked;app.collection.changed(checked)});var initData=app.util.storage.load();if(initData){console.log(initData);app.collection.set(initData)}})(jQuery,window,Todo);(function(){var cache={};this.tmpl=function tmpl(str,data){var fn=!/\W/.test(str)?cache[str]=cache[str]||tmpl(document.getElementById(str).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+str.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return data?fn(data):fn}})();(function(app){app.util={uniqId:function(){return(new Date).getTime()},storage:{load:function(){console.log("storage.load()");return JSON.parse(localStorage.getItem(app.storageKey)||"[]")},save:function(event,data){console.log("storage.save()");localStorage.setItem(app.storageKey,JSON.stringify(data))}}};app.$wrap.on("addCollection",app.util.storage.save);app.$wrap.on("removeCollection",app.util.storage.save);app.$wrap.on("changedCollection",app.util.storage.save)})(Todo);